(window.webpackJsonp=window.webpackJsonp||[]).push([[93],{710:function(s,a,t){"use strict";t.r(a);var e=t(33),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"第1章-多版本并发控制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第1章-多版本并发控制"}},[s._v("#")]),s._v(" 第1章 多版本并发控制")]),s._v(" "),t("h2",{attrs:{id:"_1-什么是mvcc"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-什么是mvcc"}},[s._v("#")]),s._v(" "),t("strong",[s._v("1.")]),s._v(" "),t("strong",[s._v("什么是MVCC")])]),s._v(" "),t("p",[s._v("MVCC （Multiversion Concurrency Control），多版本并发控制。顾名思义，MVCC 是通过数据行的多个版本管理来实现数据库的"),t("code",[s._v("并发控制")]),s._v("。这项技术使得在InnoDB的事务隔离级别下执行"),t("code",[s._v("一致性读")]),s._v("操作有了保证。换言之，就是为了查询一些正在被另一个事务更新的行，并且可以看到它们被更新之前的值，这样在做查询的时候就不用等待另一个事务释放锁。")]),s._v(" "),t("h2",{attrs:{id:"_2-快照读与当前读"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-快照读与当前读"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.")]),s._v(" "),t("strong",[s._v("快照读与当前读")])]),s._v(" "),t("p",[s._v("MVCC在MySQL InnoDB中的实现主要是为了提高数据库并发性能，用更好的方式去处理"),t("code",[s._v("读-写冲突")]),s._v("，做到即使有读写冲突时，也能做到"),t("code",[s._v("不加锁")]),s._v("，"),t("code",[s._v("非阻塞并发读")]),s._v("，而这个读指的就是"),t("code",[s._v("快照读")]),s._v(", 而非"),t("code",[s._v("当前读")]),s._v("。当前读实际上是一种加锁的操作，是悲观锁的实现。而MVCC本质是采用乐观锁思想的一种方式。")]),s._v(" "),t("h3",{attrs:{id:"_2-1-快照读"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-快照读"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.1")]),s._v(" "),t("strong",[s._v("快照读")])]),s._v(" "),t("p",[s._v("快照读又叫一致性读，读取的是快照数据。"),t("strong",[s._v("不加锁的简单的")]),s._v(" "),t("strong",[s._v("SELECT")]),s._v(" "),t("strong",[s._v("都属于快照读")]),s._v("，即不加锁的非阻塞读。")]),s._v(" "),t("p",[s._v("之所以出现快照读的情况，是基于提高并发性能的考虑，快照读的实现是基于MVCC，它在很多情况下，避免了加锁操作，降低了开销。")]),s._v(" "),t("p",[s._v("既然是基于多版本，那么快照读可能读到的并不一定是数据的最新版本，而有可能是之前的历史版本。")]),s._v(" "),t("p",[s._v("快照读的前提是隔离级别不是串行级别，串行级别下的快照读会退化成当前读。")]),s._v(" "),t("h3",{attrs:{id:"_2-2-当前读"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-当前读"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.2")]),s._v(" "),t("strong",[s._v("当前读")])]),s._v(" "),t("p",[s._v("当前读读取的是记录的最新版本（最新数据，而不是历史版本的数据），读取时还要保证其他并发事务不能修改当前记录，会对读取的记录进行加锁。加锁的 SELECT，或者对数据进行增删改都会进行当前读。")]),s._v(" "),t("h2",{attrs:{id:"_3-复习"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-复习"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.")]),s._v(" "),t("strong",[s._v("复习")])]),s._v(" "),t("h3",{attrs:{id:"_3-1-再谈隔离级别"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-再谈隔离级别"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.1")]),s._v(" "),t("strong",[s._v("再谈隔离级别")])]),s._v(" "),t("p",[s._v("我们知道事务有 4 个隔离级别，可能存在三种并发问题：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051536648.png",alt:"image-20220405153617536"}})]),s._v(" "),t("p",[s._v("另图：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051536125.png",alt:"image-20220405153632021"}})]),s._v(" "),t("h3",{attrs:{id:"_3-2-隐藏字段、undo-log版本链"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-隐藏字段、undo-log版本链"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.2")]),s._v(" "),t("strong",[s._v("隐藏字段、Undo Log版本链")])]),s._v(" "),t("p",[s._v("回顾一下undo日志的版本链，对于使用"),t("code",[s._v("InnoDB")]),s._v("存储引擎的表来说，它的聚簇索引记录中都包含两个必要的隐藏列。")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("trx_id")]),s._v("：每次一个事务对某条聚簇索引记录进行改动时，都会把该事务的"),t("code",[s._v("事务id")]),s._v("赋值给trx_id 隐藏列。")]),s._v(" "),t("li",[t("code",[s._v("roll_pointer")]),s._v("：每次对某条聚簇索引记录进行改动时，都会把旧的版本写入到 undo日志 中，然后这个隐藏列就相当于一个指针，可以通过它来找到该记录修改前的信息。")])]),s._v(" "),t("h2",{attrs:{id:"_4-mvcc实现原理之readview"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-mvcc实现原理之readview"}},[s._v("#")]),s._v(" "),t("strong",[s._v("4. MVCC实现原理之ReadView")])]),s._v(" "),t("p",[s._v("MVCC 的实现依赖于："),t("strong",[s._v("隐藏字段、Undo Log、Read View")]),s._v("。")]),s._v(" "),t("h3",{attrs:{id:"_4-1-什么是readview"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-什么是readview"}},[s._v("#")]),s._v(" "),t("strong",[s._v("4.1")]),s._v(" "),t("strong",[s._v("什么是ReadView")])]),s._v(" "),t("p",[s._v("ReadView就是事务在使用MVCC机制进行快照读操作时产生的读视图。当事务启动时，会生成数据库系统当前的一个快照，InnoDB为每个事务构造了一个数组，用来记录并维护系统当前"),t("code",[s._v("活跃事务")]),s._v("的ID（“活跃”指的就是，启动了但还没提交）。")]),s._v(" "),t("h3",{attrs:{id:"_4-2-设计思路"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-设计思路"}},[s._v("#")]),s._v(" "),t("strong",[s._v("4.2")]),s._v(" "),t("strong",[s._v("设计思路")])]),s._v(" "),t("p",[s._v("使用"),t("code",[s._v("READ UNCOMMITTED")]),s._v("隔离级别的事务，由于可以读到未提交事务修改过的记录，所以直接读取记录的最新版本就好了。")]),s._v(" "),t("p",[s._v("使用"),t("code",[s._v("SERIALIZABLE")]),s._v("隔离级别的事务，InnoDB规定使用加锁的方式来访问记录。")]),s._v(" "),t("p",[s._v("使用"),t("code",[s._v("READ COMMITTED")]),s._v("和"),t("code",[s._v("REPEATABLE READ")]),s._v("隔离级别的事务，都必须保证读到"),t("code",[s._v("已经提交了的")]),s._v("事务修改过的记录。假如另一个事务已经修改了记录但是尚未提交，是不能直接读取最新版本的记录的，核心问题就是需要判断一下版本链中的哪个版本是当前事务可见的，这是ReadView要解决的主要问题。")]),s._v(" "),t("p",[s._v("这个ReadView中主要包含4个比较重要的内容，分别如下：")]),s._v(" "),t("ol",[t("li",[t("code",[s._v("creator_trx_id")]),s._v("，创建这个 Read View 的事务 ID。")])]),s._v(" "),t("blockquote",[t("p",[s._v("说明：只有在对表中的记录做改动时（执行INSERT、DELETE、UPDATE这些语句时）才会为事务分配事务id，否则在一个只读事务中的事务id值都默认为0。")])]),s._v(" "),t("ol",{attrs:{start:"2"}},[t("li",[t("p",[t("code",[s._v("trx_ids")]),s._v("，表示在生成ReadView时当前系统中活跃的读写事务的"),t("code",[s._v("事务id列表")]),s._v("。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("up_limit_id")]),s._v("，活跃的事务中最小的事务 ID。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("low_limit_id")]),s._v("，表示生成ReadView时系统中应该分配给下一个事务的"),t("code",[s._v("id")]),s._v("值。low_limit_id 是系统最大的事务id值，这里要注意是系统中的事务id，需要区别于正在活跃的事务ID。")])])]),s._v(" "),t("blockquote",[t("p",[s._v("注意：low_limit_id并不是trx_ids中的最大值，事务id是递增分配的。比如，现在有id为1， 2，3这三个事务，之后id为3的事务提交了。那么一个新的读事务在生成ReadView时，trx_ids就包括1和2，up_limit_id的值就是1，low_limit_id的值就是4。")])]),s._v(" "),t("h3",{attrs:{id:"_4-3-readview的规则"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-readview的规则"}},[s._v("#")]),s._v(" "),t("strong",[s._v("4.3 ReadView的规则")])]),s._v(" "),t("p",[s._v("有了这个ReadView，这样在访问某条记录时，只需要按照下边的步骤判断记录的某个版本是否可见。")]),s._v(" "),t("ul",[t("li",[s._v("如果被访问版本的trx_id属性值与ReadView中的"),t("code",[s._v("creator_trx_id")]),s._v("值相同，意味着当前事务在访问它自己修改过的记录，所以该版本可以被当前事务访问。")]),s._v(" "),t("li",[s._v("如果被访问版本的trx_id属性值小于ReadView中的"),t("code",[s._v("up_limit_id")]),s._v("值，表明生成该版本的事务在当前事务生成ReadView前已经提交，所以该版本可以被当前事务访问。")]),s._v(" "),t("li",[s._v("如果被访问版本的trx_id属性值大于或等于ReadView中的"),t("code",[s._v("low_limit_id")]),s._v("值，表明生成该版本的事务在当前事务生成ReadView后才开启，所以该版本不可以被当前事务访问。")]),s._v(" "),t("li",[s._v("如果被访问版本的trx_id属性值在ReadView的"),t("code",[s._v("up_limit_id")]),s._v("和"),t("code",[s._v("low_limit_id")]),s._v("之间，那就需要判断一下trx_id属性值是不是在 trx_ids 列表中。\n"),t("ul",[t("li",[s._v("如果在，说明创建ReadView时生成该版本的事务还是活跃的，该版本不可以被访问。")]),s._v(" "),t("li",[s._v("如果不在，说明创建ReadView时生成该版本的事务已经被提交，该版本可以被访问。")])])])]),s._v(" "),t("h3",{attrs:{id:"_4-4-mvcc整体操作流程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-mvcc整体操作流程"}},[s._v("#")]),s._v(" "),t("strong",[s._v("4.4 MVCC整体操作流程")])]),s._v(" "),t("p",[s._v("了解了这些概念之后，我们来看下当查询一条记录的时候，系统如何通过MVCC找到它：")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("首先获取事务自己的版本号，也就是事务 ID；")])]),s._v(" "),t("li",[t("p",[s._v("获取 ReadView；")])]),s._v(" "),t("li",[t("p",[s._v("查询得到的数据，然后与 ReadView 中的事务版本号进行比较；")])]),s._v(" "),t("li",[t("p",[s._v("如果不符合 ReadView 规则，就需要从 Undo Log 中获取历史快照；")])]),s._v(" "),t("li",[t("p",[s._v("最后返回符合规则的数据。")])])]),s._v(" "),t("p",[s._v("在隔离级别为读已提交（Read Committed）时，一个事务中的每一次 SELECT 查询都会重新获取一次Read View。")]),s._v(" "),t("p",[s._v("如表所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051549618.png",alt:"image-20220405154948505"}})]),s._v(" "),t("blockquote",[t("p",[s._v("注意，此时同样的查询语句都会重新获取一次 Read View，这时如果 Read View 不同，就可能产生不可重复读或者幻读的情况。")])]),s._v(" "),t("p",[s._v("当隔离级别为可重复读的时候，就避免了不可重复读，这是因为一个事务只在第一次 SELECT 的时候会获取一次 Read View，而后面所有的 SELECT 都会复用这个 Read View，如下表所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051550072.png",alt:"image-20220405155041964"}})]),s._v(" "),t("h2",{attrs:{id:"_5-举例说明"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-举例说明"}},[s._v("#")]),s._v(" "),t("strong",[s._v("5.")]),s._v(" "),t("strong",[s._v("举例说明")])]),s._v(" "),t("h3",{attrs:{id:"_5-1-read-committed隔离级别下"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-read-committed隔离级别下"}},[s._v("#")]),s._v(" "),t("strong",[s._v("5.1 READ COMMITTED隔离级别下")])]),s._v(" "),t("p",[t("strong",[s._v("READ COMMITTED")]),s._v(" "),t("strong",[s._v("：每次读取数据前都生成一个ReadView")]),s._v("。")]),s._v(" "),t("h3",{attrs:{id:"_5-2-repeatable-read隔离级别下"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-repeatable-read隔离级别下"}},[s._v("#")]),s._v(" "),t("strong",[s._v("5.2 REPEATABLE READ隔离级别下")])]),s._v(" "),t("p",[s._v("使用"),t("code",[s._v("REPEATABLE READ")]),s._v("隔离级别的事务来说，只会在第一次执行查询语句时生成一个 ReadView ，之后的查询就不会重复生成了。")]),s._v(" "),t("h3",{attrs:{id:"_5-3-如何解决幻读"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-如何解决幻读"}},[s._v("#")]),s._v(" "),t("strong",[s._v("5.3")]),s._v(" "),t("strong",[s._v("如何解决幻读")])]),s._v(" "),t("p",[s._v("假设现在表 student 中只有一条数据，数据内容中，主键 id=1，隐藏的 trx_id=10，它的 undo log 如下图所示。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051556631.png",alt:"image-20220405155640520"}})]),s._v(" "),t("p",[s._v("假设现在有事务 A 和事务 B 并发执行，"),t("code",[s._v("事务 A")]),s._v("的事务 id 为"),t("code",[s._v("20")]),s._v("，"),t("code",[s._v("事务 B")]),s._v("的事务 id 为"),t("code",[s._v("30")]),s._v("。")]),s._v(" "),t("p",[s._v("步骤1：事务 A 开始第一次查询数据，查询的 SQL 语句如下。")]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("select * from student where id >= 1;\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("在开始查询之前，MySQL 会为事务 A 产生一个 ReadView，此时 ReadView 的内容如下："),t("code",[s._v("trx_ids= [20,30]")]),s._v("，"),t("code",[s._v("up_limit_id=20")]),s._v("，"),t("code",[s._v("low_limit_id=31")]),s._v("，"),t("code",[s._v("creator_trx_id=20")]),s._v("。")]),s._v(" "),t("p",[s._v("由于此时表 student 中只有一条数据，且符合 where id>=1 条件，因此会查询出来。然后根据 ReadView机制，发现该行数据的trx_id=10，小于事务 A 的 ReadView 里 up_limit_id，这表示这条数据是事务 A 开启之前，其他事务就已经提交了的数据，因此事务 A 可以读取到。")]),s._v(" "),t("p",[s._v("结论：事务 A 的第一次查询，能读取到一条数据，id=1。")]),s._v(" "),t("p",[s._v("步骤2：接着事务 B(trx_id=30)，往表 student 中新插入两条数据，并提交事务。")]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("insert into student(id,name) values(2,'李四'); \ninsert into student(id,name) values(3,'王五');\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("此时表student 中就有三条数据了，对应的 undo 如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051559345.png",alt:"image-20220405155909223"}})]),s._v(" "),t("p",[s._v("步骤3：接着事务 A 开启第二次查询，根据可重复读隔离级别的规则，此时事务 A 并不会再重新生成ReadView。此时表 student 中的 3 条数据都满足 where id>=1 的条件，因此会先查出来。然后根据ReadView 机制，判断每条数据是不是都可以被事务 A 看到。")]),s._v(" "),t("p",[s._v("1）首先 id=1 的这条数据，前面已经说过了，可以被事务 A 看到。")]),s._v(" "),t("p",[s._v("2）然后是 id=2 的数据，它的 trx_id=30，此时事务 A 发现，这个值处于 up_limit_id 和 low_limit_id 之间，因此还需要再判断 30 是否处于 trx_ids 数组内。由于事务 A 的 trx_ids=[20,30]，因此在数组内，这表示 id=2 的这条数据是与事务 A 在同一时刻启动的其他事务提交的，所以这条数据不能让事务 A 看到。")]),s._v(" "),t("p",[s._v("3）同理，id=3 的这条数据，trx_id 也为 30，因此也不能被事务 A 看见。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051559867.png",alt:"image-20220405155941753"}})]),s._v(" "),t("p",[s._v("结论：最终事务 A 的第二次查询，只能查询出 id=1 的这条数据。这和事务 A 的第一次查询的结果是一样的，因此没有出现幻读现象，所以说在 MySQL 的可重复读隔离级别下，不存在幻读问题。")]),s._v(" "),t("h2",{attrs:{id:"_6-总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-总结"}},[s._v("#")]),s._v(" "),t("strong",[s._v("6.")]),s._v(" "),t("strong",[s._v("总结")])]),s._v(" "),t("p",[s._v("这里介绍了"),t("code",[s._v("MVCC")]),s._v("在"),t("code",[s._v("READ COMMITTD")]),s._v("、"),t("code",[s._v("REPEATABLE READ")]),s._v("这两种隔离级别的事务在执行快照读操作时访问记录的版本链的过程。这样使不同事务的"),t("code",[s._v("读-写")]),s._v("、"),t("code",[s._v("写-读")]),s._v("操作并发执行，从而提升系统性能。")]),s._v(" "),t("p",[s._v("核心点在于 ReadView 的原理，"),t("code",[s._v("READ COMMITTD")]),s._v("、"),t("code",[s._v("REPEATABLE READ")]),s._v("这两个隔离级别的一个很大不同就是生成ReadView的时机不同：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("READ COMMITTD")]),s._v("在每一次进行普通SELECT操作前都会生成一个ReadView")]),s._v(" "),t("li",[t("code",[s._v("REPEATABLE READ")]),s._v("只在第一次进行普通SELECT操作前生成一个ReadView，之后的查询操作都重复使用这个ReadView就好了。")])]),s._v(" "),t("h1",{attrs:{id:"第2章-其它数据库日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第2章-其它数据库日志"}},[s._v("#")]),s._v(" 第2章 其它数据库日志")]),s._v(" "),t("h2",{attrs:{id:"_1-mysql支持的日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-mysql支持的日志"}},[s._v("#")]),s._v(" "),t("strong",[s._v("1. MySQL支持的日志")])]),s._v(" "),t("h3",{attrs:{id:"_1-1-日志类型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-日志类型"}},[s._v("#")]),s._v(" "),t("strong",[s._v("1.1")]),s._v(" "),t("strong",[s._v("日志类型")])]),s._v(" "),t("p",[s._v("MySQL有不同类型的日志文件，用来存储不同类型的日志，分为"),t("code",[s._v("二进制日志")]),s._v("、"),t("code",[s._v("错误日志")]),s._v("、"),t("code",[s._v("通用查询日志")]),s._v("和"),t("code",[s._v("慢查询日志")]),s._v("，这也是常用的4种。MySQL 8又新增两种支持的日志："),t("code",[s._v("中继日志")]),s._v("和"),t("code",[s._v("数据定义语句日志")]),s._v("。使用这些日志文件，可以查看MySQL内部发生的事情。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("**慢查询日志：**记录所有执行时间超过long_query_time的所有查询，方便我们对查询进行优化。")])]),s._v(" "),t("li",[t("p",[s._v("**通用查询日志：**记录所有连接的起始时间和终止时间，以及连接发送给数据库服务器的所有指令，对我们复原操作的实际场景、发现问题，甚至是对数据库操作的审计都有很大的帮助。")])]),s._v(" "),t("li",[t("p",[s._v("**错误日志：**记录MySQL服务的启动、运行或停止MySQL服务时出现的问题，方便我们了解服务器的状态，从而对服务器进行维护。")])]),s._v(" "),t("li",[t("p",[s._v("**二进制日志：**记录所有更改数据的语句，可以用于主从服务器之间的数据同步，以及服务器遇到故障时数据的无损失恢复。")])]),s._v(" "),t("li",[t("p",[s._v("**中继日志：**用于主从服务器架构中，从服务器用来存放主服务器二进制日志内容的一个中间文件。从服务器通过读取中继日志的内容，来同步主服务器上的操作。")])]),s._v(" "),t("li",[t("p",[s._v("**数据定义语句日志：**记录数据定义语句执行的元数据操作。")])])]),s._v(" "),t("p",[s._v("除二进制日志外，其他日志都是"),t("code",[s._v("文本文件")]),s._v("。默认情况下，所有日志创建于"),t("code",[s._v("MySQL数据目录")]),s._v("中。")]),s._v(" "),t("h3",{attrs:{id:"_1-2-日志的弊端"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-日志的弊端"}},[s._v("#")]),s._v(" "),t("strong",[s._v("1.2")]),s._v(" "),t("strong",[s._v("日志的弊端")])]),s._v(" "),t("ul",[t("li",[t("p",[s._v("日志功能会"),t("code",[s._v("降低MySQL数据库的性能")]),s._v("。")])]),s._v(" "),t("li",[t("p",[s._v("日志会"),t("code",[s._v("占用大量的磁盘空间")]),s._v("。")])])]),s._v(" "),t("h2",{attrs:{id:"_2-通用查询日志-general-query-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-通用查询日志-general-query-log"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.")]),s._v(" "),t("strong",[s._v("通用查询日志(general query log)")])]),s._v(" "),t("p",[s._v("通用查询日志用来"),t("code",[s._v("记录用户的所有操作")]),s._v("，包括启动和关闭MySQL服务、所有用户的连接开始时间和截止时间、发给 MySQL 数据库服务器的所有 SQL 指令等。当我们的数据发生异常时，"),t("strong",[s._v("查看通用查询日志，还原操作时的具体场景")]),s._v("，可以帮助我们准确定位问题。")]),s._v(" "),t("h3",{attrs:{id:"_2-1-查看当前状态"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-查看当前状态"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.1")]),s._v(" "),t("strong",[s._v("查看当前状态")])]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> SHOW VARIABLES LIKE '%general%';\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_2-2-启动日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-启动日志"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.2")]),s._v(" "),t("strong",[s._v("启动日志")])]),s._v(" "),t("p",[t("strong",[s._v("方式1：永久性方式")])]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mysqld")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("general_log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("ON")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("general_log_file")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("[path[filename]] #日志文件所在目录路径，filename为日志文件名")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[t("strong",[s._v("方式2：临时性方式")])]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("SET GLOBAL general_log=on; # 开启通用查询日志\nSET GLOBAL general_log_file=’path/filename’; # 设置日志文件保存位置\nSET GLOBAL general_log=off; # 关闭通用查询日志\nSHOW VARIABLES LIKE 'general_log%'; # 查看设置后情况\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h3",{attrs:{id:"_2-3-停止日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-停止日志"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.3")]),s._v(" "),t("strong",[s._v("停止日志")])]),s._v(" "),t("p",[t("strong",[s._v("方式1：永久性方式")])]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mysqld")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("general_log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("OFF")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("strong",[s._v("方式2：临时性方式")])]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("SET GLOBAL general_log=off;\nSHOW VARIABLES LIKE 'general_log%';\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h2",{attrs:{id:"_3-错误日志-error-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-错误日志-error-log"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.错误日志(error log)")])]),s._v(" "),t("h3",{attrs:{id:"_3-1-启动日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-启动日志"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.1")]),s._v(" "),t("strong",[s._v("启动日志")])]),s._v(" "),t("p",[s._v("在MySQL数据库中，错误日志功能是"),t("code",[s._v("默认开启")]),s._v("的。而且，错误日志"),t("code",[s._v("无法被禁止")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mysqld")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log-error")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("[path/[filename]] #path为日志文件所在的目录路径，filename为日志文件名")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"_3-2-查看日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-查看日志"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.2")]),s._v(" "),t("strong",[s._v("查看日志")])]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> SHOW VARIABLES LIKE 'log_err%';\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_3-3-删除-刷新日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-删除-刷新日志"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.3")]),s._v(" "),t("strong",[s._v("删除\\刷新日志")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -omysql -gmysql -m0644 /dev/null /var/log/mysqld.log\nmysqladmin -uroot -p flush-logs\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h2",{attrs:{id:"_4-二进制日志-bin-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-二进制日志-bin-log"}},[s._v("#")]),s._v(" "),t("strong",[s._v("4.")]),s._v(" "),t("strong",[s._v("二进制日志(bin log)")])]),s._v(" "),t("h3",{attrs:{id:"_4-1-查看默认情况"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-查看默认情况"}},[s._v("#")]),s._v(" "),t("strong",[s._v("4.1")]),s._v(" "),t("strong",[s._v("查看默认情况")])]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> show variables like '%log_bin%';\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_4-2-日志参数设置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-日志参数设置"}},[s._v("#")]),s._v(" "),t("strong",[s._v("4.2")]),s._v(" "),t("strong",[s._v("日志参数设置")])]),s._v(" "),t("p",[t("strong",[s._v("方式1：永久性方式")])]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mysqld")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#启用二进制日志 ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log-bin")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("atguigu-bin")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("binlog_expire_logs_seconds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("600 max_binlog_size=100M")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[t("strong",[s._v("设置带文件夹的bin-log日志存放目录")])]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token section"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mysqld")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log-bin")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token inner-value"}},[s._v("/var/lib/mysql/binlog/atguigu-bin")]),s._v('"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("注意：新建的文件夹需要使用mysql用户，使用下面的命令即可。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R -v mysql:mysql binlog\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("strong",[s._v("方式2：临时性方式")])]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# global 级别 \nmysql> set global sql_log_bin=0; \nERROR 1228 (HY000): Variable 'sql_log_bin' is a SESSION variable and can`t be used with SET GLOBAL \n\n# session级别 \nmysql> SET sql_log_bin=0; \nQuery OK, 0 rows affected (0.01 秒)\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h3",{attrs:{id:"_4-3-查看日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-查看日志"}},[s._v("#")]),s._v(" "),t("strong",[s._v("4.3")]),s._v(" "),t("strong",[s._v("查看日志")])]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('mysqlbinlog -v "/var/lib/mysql/binlog/atguigu-bin.000002"\n# 不显示binlog格式的语句\nmysqlbinlog -v --base64-output=DECODE-ROWS "/var/lib/mysql/binlog/atguigu-bin.000002"\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# 可查看参数帮助 \nmysqlbinlog --no-defaults --help \n\n# 查看最后100行 \nmysqlbinlog --no-defaults --base64-output=decode-rows -vv atguigu-bin.000002 |tail -100 \n\n# 根据position查找 \nmysqlbinlog --no-defaults --base64-output=decode-rows -vv atguigu-bin.000002 |grep -A20 '4939002'\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("上面这种办法读取出binlog日志的全文内容比较多，不容易分辨查看到pos点信息，下面介绍一种更为方便的查询命令：")]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> show binlog events [IN 'log_name'] [FROM pos] [LIMIT [offset,] row_count];\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[t("code",[s._v("IN 'log_name'")]),s._v("：指定要查询的binlog文件名（不指定就是第一个binlog文件）")]),s._v(" "),t("li",[t("code",[s._v("FROM pos")]),s._v("：指定从哪个pos起始点开始查起（不指定就是从整个文件首个pos点开始算）")]),s._v(" "),t("li",[t("code",[s._v("LIMIT [offset]")]),s._v("：偏移量(不指定就是0)")]),s._v(" "),t("li",[t("code",[s._v("row_count")]),s._v(":查询总条数（不指定就是所有行）")])]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> show binlog events in 'atguigu-bin.000002';\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_4-4-使用日志恢复数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-使用日志恢复数据"}},[s._v("#")]),s._v(" "),t("strong",[s._v("4.4")]),s._v(" "),t("strong",[s._v("使用日志恢复数据")])]),s._v(" "),t("p",[s._v("mysqlbinlog恢复数据的语法如下：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysqlbinlog "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("option"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" filename"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("mysql –uuser -ppass"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[t("code",[s._v("filename")]),s._v("：是日志文件名。")]),s._v(" "),t("li",[t("code",[s._v("option")]),s._v("：可选项，比较重要的两对option参数是--start-date、--stop-date 和 --start-position、-- stop-position。\n"),t("ul",[t("li",[t("code",[s._v("--start-date 和 --stop-date")]),s._v("：可以指定恢复数据库的起始时间点和结束时间点。")]),s._v(" "),t("li",[t("code",[s._v("--start-position和--stop-position")]),s._v("：可以指定恢复数据的开始位置和结束位置。")])])])]),s._v(" "),t("blockquote",[t("p",[s._v("注意：使用mysqlbinlog命令进行恢复操作时，必须是编号小的先恢复，例如atguigu-bin.000001必须在atguigu-bin.000002之前恢复。")])]),s._v(" "),t("h3",{attrs:{id:"_4-5-删除二进制日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-删除二进制日志"}},[s._v("#")]),s._v(" "),t("strong",[s._v("4.5")]),s._v(" "),t("strong",[s._v("删除二进制日志")])]),s._v(" "),t("p",[t("strong",[s._v("1. PURGE MASTER LOGS：删除指定日志文件")])]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("PURGE {MASTER | BINARY} LOGS TO ‘指定日志文件名’ \nPURGE {MASTER | BINARY} LOGS BEFORE ‘指定日期’\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h2",{attrs:{id:"_5-再谈二进制日志-binlog"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-再谈二进制日志-binlog"}},[s._v("#")]),s._v(" "),t("strong",[s._v("5.")]),s._v(" "),t("strong",[s._v("再谈二进制日志(binlog)")])]),s._v(" "),t("h3",{attrs:{id:"_5-1-写入机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-写入机制"}},[s._v("#")]),s._v(" "),t("strong",[s._v("5.1")]),s._v(" "),t("strong",[s._v("写入机制")])]),s._v(" "),t("p",[s._v("binlog的写入时机也非常简单，事务执行过程中，先把日志写到"),t("code",[s._v("binlog cache")]),s._v("，事务提交的时候，再把binlog cache写到binlog文件中。因为一个事务的binlog不能被拆开，无论这个事务多大，也要确保一次性写入，所以系统会给每个线程分配一个块内存作为binlog cache。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051630535.png",alt:"image-20220405163025361"}})]),s._v(" "),t("p",[s._v("write和fsync的时机，可以由参数"),t("code",[s._v("sync_binlog")]),s._v("控制，默认是 "),t("code",[s._v("0")]),s._v("。为0的时候，表示每次提交事务都只write，由系统自行判断什么时候执行fsync。虽然性能得到提升，但是机器宕机，page cache里面的binglog 会丢失。如下图：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051631346.png",alt:"image-20220405163125180"}})]),s._v(" "),t("p",[s._v("为了安全起见，可以设置为"),t("code",[s._v("1")]),s._v("，表示每次提交事务都会执行fsync，就如同"),t("strong",[s._v("redo log")]),s._v(" "),t("strong",[s._v("刷盘流程")]),s._v("一样。最后还有一种折中方式，可以设置为N(N>1)，表示每次提交事务都write，但累积N个事务后才fsync。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051632526.png",alt:"image-20220405163205364"}})]),s._v(" "),t("p",[s._v("在出现IO瓶颈的场景里，将sync_binlog设置成一个比较大的值，可以提升性能。同样的，如果机器宕机，会丢失最近N个事务的binlog日志。")]),s._v(" "),t("h3",{attrs:{id:"_5-2-binlog与redolog对比"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-binlog与redolog对比"}},[s._v("#")]),s._v(" "),t("strong",[s._v("5.2 binlog与redolog对比")])]),s._v(" "),t("ul",[t("li",[s._v("redo log 它是"),t("code",[s._v("物理日志")]),s._v("，记录内容是“在某个数据页上做了什么修改”，属于 InnoDB 存储引擎层产生的。")]),s._v(" "),t("li",[s._v("而 binlog 是"),t("code",[s._v("逻辑日志")]),s._v("，记录内容是语句的原始逻辑，类似于“给 ID=2 这一行的 c 字段加 1”，属于MySQL Server 层。")]),s._v(" "),t("li",[s._v("虽然它们都属于持久化的保证，但是侧重点不同。\n"),t("ul",[t("li",[s._v("redo log 让InnoDB存储引擎拥有了崩溃恢复能力。")]),s._v(" "),t("li",[s._v("binlog保证了MySQL集群架构的数据一致性")])])])]),s._v(" "),t("h3",{attrs:{id:"_5-3-两阶段提交"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-两阶段提交"}},[s._v("#")]),s._v(" "),t("strong",[s._v("5.3")]),s._v(" "),t("strong",[s._v("两阶段提交")])]),s._v(" "),t("p",[s._v("在执行更新语句过程，会记录redo log与binlog两块日志，以基本的事务为单位，redo log在事务执行过程中可以不断写入，而binlog只有在提交事务时才写入，所以redo log与binlog的"),t("code",[s._v("写入时机")]),s._v("不一样。")]),s._v(" "),t("p",[s._v("为了解决两份日志之间的逻辑一致问题，InnoDB存储引擎使用"),t("strong",[s._v("两阶段提交")]),s._v("方案。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051637390.png",alt:"image-20220405163716222"}})]),s._v(" "),t("p",[s._v("使用"),t("strong",[s._v("两阶段提交")]),s._v("后，写入binlog时发生异常也不会有影响")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051639192.png",alt:"image-20220405163902977"}})]),s._v(" "),t("p",[s._v("另一个场景，redo log设置commit阶段发生异常，那会不会回滚事务呢？")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051639403.png",alt:"image-20220405163927129"}})]),s._v(" "),t("p",[s._v("并不会回滚事务，它会执行上图框住的逻辑，虽然redo log是处于prepare阶段，但是能通过事务id找到对应的binlog日志，所以MySQL认为是完整的，就会提交事务恢复数据。")]),s._v(" "),t("h2",{attrs:{id:"_6-中继日志-relay-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-中继日志-relay-log"}},[s._v("#")]),s._v(" "),t("strong",[s._v("6.")]),s._v(" "),t("strong",[s._v("中继日志(relay log)")])]),s._v(" "),t("h3",{attrs:{id:"_6-1-介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-介绍"}},[s._v("#")]),s._v(" "),t("strong",[s._v("6.1")]),s._v(" "),t("strong",[s._v("介绍")])]),s._v(" "),t("p",[t("strong",[s._v("中继日志只在主从服务器架构的从服务器上存在")]),s._v("。从服务器为了与主服务器保持一致，要从主服务器读取二进制日志的内容，并且把读取到的信息写入"),t("code",[s._v("本地的日志文件")]),s._v("中，这个从服务器本地的日志文件就叫"),t("code",[s._v("中继日志")]),s._v("。然后，从服务器读取中继日志，并根据中继日志的内容对从服务器的数据进行更新，完成主从服务器的"),t("code",[s._v("数据同步")]),s._v("。")]),s._v(" "),t("h3",{attrs:{id:"_6-2-恢复的典型错误"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-恢复的典型错误"}},[s._v("#")]),s._v(" "),t("strong",[s._v("6.2")]),s._v(" "),t("strong",[s._v("恢复的典型错误")])]),s._v(" "),t("p",[s._v("如果从服务器宕机，有的时候为了系统恢复，要重装操作系统，这样就可能会导致你的"),t("code",[s._v("服务器名称")]),s._v("与之前"),t("code",[s._v("不同")]),s._v("。而中继日志里是"),t("code",[s._v("包含从服务器名")]),s._v("的。在这种情况下，就可能导致你恢复从服务器的时候，无法从宕机前的中继日志里读取数据，以为是日志文件损坏了，其实是名称不对了。")]),s._v(" "),t("p",[s._v("解决的方法也很简单，把从服务器的名称改回之前的名称。")]),s._v(" "),t("h1",{attrs:{id:"第3章-主从复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第3章-主从复制"}},[s._v("#")]),s._v(" 第3章 主从复制")]),s._v(" "),t("h2",{attrs:{id:"_1-主从复制概述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-主从复制概述"}},[s._v("#")]),s._v(" "),t("strong",[s._v("1.")]),s._v(" "),t("strong",[s._v("主从复制概述")])]),s._v(" "),t("h3",{attrs:{id:"_1-1-如何提升数据库并发能力"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-如何提升数据库并发能力"}},[s._v("#")]),s._v(" "),t("strong",[s._v("1.1")]),s._v(" "),t("strong",[s._v("如何提升数据库并发能力")])]),s._v(" "),t("p",[s._v("一般应用对数据库而言都是“"),t("code",[s._v("读多写少")]),s._v("”，也就说对数据库读取数据的压力比较大，有一个思路就是采用数据库集群的方案，做"),t("code",[s._v("主从架构")]),s._v("、进行"),t("code",[s._v("读写分离")]),s._v("，这样同样可以提升数据库的并发处理能力。但并不是所有的应用都需要对数据库进行主从架构的设置，毕竟设置架构本身是有成本的。")]),s._v(" "),t("p",[s._v("如果我们的目的在于提升数据库高并发访问的效率，那么首先考虑的是如何"),t("code",[s._v("优化SQL和索引")]),s._v("，这种方式简单有效；其次才是采用"),t("code",[s._v("缓存的策略")]),s._v("，比如使用 Redis将热点数据保存在内存数据库中，提升读取的效率；最后才是对数据库采用"),t("code",[s._v("主从架构")]),s._v("，进行读写分离。")]),s._v(" "),t("h3",{attrs:{id:"_1-2-主从复制的作用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-主从复制的作用"}},[s._v("#")]),s._v(" "),t("strong",[s._v("1.2")]),s._v(" "),t("strong",[s._v("主从复制的作用")])]),s._v(" "),t("p",[t("strong",[s._v("第1个作用：读写分离。")])]),s._v(" "),t("p",[t("strong",[s._v("第2个作用就是数据备份。")])]),s._v(" "),t("p",[t("strong",[s._v("第3个作用是具有高可用性。")])]),s._v(" "),t("h2",{attrs:{id:"_2-主从复制的原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-主从复制的原理"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.")]),s._v(" "),t("strong",[s._v("主从复制的原理")])]),s._v(" "),t("h3",{attrs:{id:"_2-1-原理剖析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-原理剖析"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.1")]),s._v(" "),t("strong",[s._v("原理剖析")])]),s._v(" "),t("p",[t("strong",[s._v("三个线程")])]),s._v(" "),t("p",[s._v("实际上主从同步的原理就是基于 binlog 进行数据同步的。在主从复制过程中，会基于"),t("code",[s._v("3 个线程")]),s._v("来操作，一个主库线程，两个从库线程。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051646097.png",alt:"image-20220405164559961"}})]),s._v(" "),t("p",[t("code",[s._v("二进制日志转储线程")]),s._v("（Binlog dump thread）是一个主库线程。当从库线程连接的时候， 主库可以将二进制日志发送给从库，当主库读取事件（Event）的时候，会在 Binlog 上"),t("code",[s._v("加锁")]),s._v("，读取完成之后，再将锁释放掉。")]),s._v(" "),t("p",[t("code",[s._v("从库 I/O 线程")]),s._v("会连接到主库，向主库发送请求更新 Binlog。这时从库的 I/O 线程就可以读取到主库的二进制日志转储线程发送的 Binlog 更新部分，并且拷贝到本地的中继日志 （Relay log）。")]),s._v(" "),t("p",[t("code",[s._v("从库 SQL 线程")]),s._v("会读取从库中的中继日志，并且执行日志中的事件，将从库中的数据与主库保持同步。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051647759.png",alt:"image-20220405164718627"}})]),s._v(" "),t("p",[t("strong",[s._v("复制三步骤")])]),s._v(" "),t("p",[s._v("步骤1："),t("code",[s._v("Master")]),s._v("将写操作记录到二进制日志（"),t("code",[s._v("binlog")]),s._v("）。")]),s._v(" "),t("p",[s._v("步骤2："),t("code",[s._v("Slave")]),s._v("将"),t("code",[s._v("Master")]),s._v("的binary log events拷贝到它的中继日志（"),t("code",[s._v("relay log")]),s._v("）；")]),s._v(" "),t("p",[s._v("步骤3："),t("code",[s._v("Slave")]),s._v("重做中继日志中的事件，将改变应用到自己的数据库中。 MySQL复制是异步的且串行化的，而且重启后从"),t("code",[s._v("接入点")]),s._v("开始复制。")]),s._v(" "),t("p",[t("strong",[s._v("复制的问题")])]),s._v(" "),t("p",[s._v("复制的最大问题："),t("code",[s._v("延时")])]),s._v(" "),t("h3",{attrs:{id:"_2-2-复制的基本原则"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-复制的基本原则"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.2")]),s._v(" "),t("strong",[s._v("复制的基本原则")])]),s._v(" "),t("ul",[t("li",[t("p",[s._v("每个"),t("code",[s._v("Slave")]),s._v("只有一个"),t("code",[s._v("Master")])])]),s._v(" "),t("li",[t("p",[s._v("每个"),t("code",[s._v("Slave")]),s._v("只能有一个唯一的服务器ID")])]),s._v(" "),t("li",[t("p",[s._v("每个"),t("code",[s._v("Master")]),s._v("可以有多个"),t("code",[s._v("Slave")])])])]),s._v(" "),t("h2",{attrs:{id:"_3-同步数据一致性问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-同步数据一致性问题"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.")]),s._v(" "),t("strong",[s._v("同步数据一致性问题")])]),s._v(" "),t("p",[t("strong",[s._v("主从同步的要求：")])]),s._v(" "),t("ul",[t("li",[t("p",[s._v("读库和写库的数据一致(最终一致)；")])]),s._v(" "),t("li",[t("p",[s._v("写数据必须写到写库；")])]),s._v(" "),t("li",[t("p",[s._v("读数据必须到读库(不一定)；")])])]),s._v(" "),t("h3",{attrs:{id:"_3-1-理解主从延迟问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-理解主从延迟问题"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.1")]),s._v(" "),t("strong",[s._v("理解主从延迟问题")])]),s._v(" "),t("p",[s._v("进行主从同步的内容是二进制日志，它是一个文件，在进行"),t("code",[s._v("网络传输")]),s._v("的过程中就一定会"),t("code",[s._v("存在主从延迟")]),s._v("（比如 500ms），这样就可能造成用户在从库上读取的数据不是最新的数据，也就是主从同步中的"),t("code",[s._v("数据不一致性")]),s._v("问题。")]),s._v(" "),t("h3",{attrs:{id:"_3-2-主从延迟问题原因"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-主从延迟问题原因"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.2")]),s._v(" "),t("strong",[s._v("主从延迟问题原因")])]),s._v(" "),t("p",[s._v("在网络正常的时候，日志从主库传给从库所需的时间是很短的，即T2-T1的值是非常小的。即，网络正常情况下，主备延迟的主要来源是备库接收完binlog和执行完这个事务之间的时间差。")]),s._v(" "),t("p",[s._v("**主备延迟最直接的表现是，从库消费中继日志（relay log）的速度，比主库生产binlog的速度要慢。**造成原因：")]),s._v(" "),t("p",[s._v("1、从库的机器性能比主库要差")]),s._v(" "),t("p",[s._v("2、从库的压力大")]),s._v(" "),t("p",[s._v("3、大事务的执行")]),s._v(" "),t("h3",{attrs:{id:"_3-3-如何减少主从延迟"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-如何减少主从延迟"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.3")]),s._v(" "),t("strong",[s._v("如何减少主从延迟")])]),s._v(" "),t("p",[s._v("若想要减少主从延迟的时间，可以采取下面的办法：")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("降低多线程大事务并发的概率，优化业务逻辑")])]),s._v(" "),t("li",[t("p",[s._v("优化SQL，避免慢SQL，"),t("code",[s._v("减少批量操作")]),s._v("，建议写脚本以update-sleep这样的形式完成。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("提高从库机器的配置")]),s._v("，减少主库写binlog和从库读binlog的效率差。")])]),s._v(" "),t("li",[t("p",[s._v("尽量采用"),t("code",[s._v("短的链路")]),s._v("，也就是主库和从库服务器的距离尽量要短，提升端口带宽，减少binlog传输的网络延时。")])]),s._v(" "),t("li",[t("p",[s._v("实时性要求的业务读强制走主库，从库只做灾备，备份。")])])]),s._v(" "),t("h3",{attrs:{id:"_3-4-如何解决一致性问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-如何解决一致性问题"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.4")]),s._v(" "),t("strong",[s._v("如何解决一致性问题")])]),s._v(" "),t("p",[s._v("读写分离情况下，解决主从同步中数据不一致的问题， 就是解决主从之间 数据复制方式 的问题，如果按照数据一致性 从弱到强 来进行划分，有以下 3 种复制方式。")]),s._v(" "),t("p",[t("strong",[s._v("方法")]),s._v(" "),t("strong",[s._v("1：异步复制")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051654133.png",alt:"image-20220405165455998"}})]),s._v(" "),t("p",[t("strong",[s._v("方法")]),s._v(" "),t("strong",[s._v("2：半同步复制")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051655175.png",alt:"image-20220405165513025"}})]),s._v(" "),t("p",[t("strong",[s._v("方法")]),s._v(" "),t("strong",[s._v("3：组复制")])]),s._v(" "),t("p",[s._v("首先我们将多个节点共同组成一个复制组，在"),t("code",[s._v("执行读写（RW）事务")]),s._v("的时候，需要通过一致性协议层（Consensus 层）的同意，也就是读写事务想要进行提交，必须要经过组里“大多数人”（对应 Node 节点）的同意，大多数指的是同意的节点数量需要大于 （N/2+1），这样才可以进行提交，而不是原发起方一个说了算。而针对"),t("code",[s._v("只读（RO）事务")]),s._v("则不需要经过组内同意，直接 COMMIT 即可。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/aoshihuankong/cloudimg@master/img/202204051656560.png",alt:"image-20220405165650425"}})]),s._v(" "),t("h1",{attrs:{id:"第4章-数据库备份与恢复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第4章-数据库备份与恢复"}},[s._v("#")]),s._v(" 第4章 数据库备份与恢复")]),s._v(" "),t("h2",{attrs:{id:"_1-物理备份与逻辑备份"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-物理备份与逻辑备份"}},[s._v("#")]),s._v(" "),t("strong",[s._v("1.")]),s._v(" "),t("strong",[s._v("物理备份与逻辑备份")])]),s._v(" "),t("p",[t("strong",[s._v("物理备份")]),s._v("：备份数据文件，转储数据库物理文件到某一目录。物理备份恢复速度比较快，但占用空间比较大，MySQL中可以用"),t("code",[s._v("xtrabackup")]),s._v("工具来进行物理备份。")]),s._v(" "),t("p",[t("strong",[s._v("逻辑备份")]),s._v("：对数据库对象利用工具进行导出工作，汇总入备份文件内。逻辑备份恢复速度慢，但占用空间小，更灵活。MySQL 中常用的逻辑备份工具为"),t("code",[s._v("mysqldump")]),s._v("。逻辑备份就是"),t("code",[s._v("备份sql语句")]),s._v("，在恢复的时候执行备份的sql语句实现数据库数据的重现。")]),s._v(" "),t("h2",{attrs:{id:"_2-mysqldump实现逻辑备份"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-mysqldump实现逻辑备份"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2. mysqldump实现逻辑备份")])]),s._v(" "),t("h3",{attrs:{id:"_2-1-备份一个数据库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-备份一个数据库"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.1")]),s._v(" "),t("strong",[s._v("备份一个数据库")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysqldump –u 用户名称 –h 主机名称 –p密码 待备份的数据库名称"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("tbname, "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("tbname"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" 备份文件名 称.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysqldump -uroot -p atguigu"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("atguigu.sql "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#备份文件存储在当前目录下")]),s._v("\nmysqldump -uroot -p atguigudb1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /var/lib/mysql/atguigu.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"_2-2-备份全部数据库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-备份全部数据库"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.2")]),s._v(" "),t("strong",[s._v("备份全部数据库")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysqldump -uroot -pxxxxxx --all-databases "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" all_database.sql \nmysqldump -uroot -pxxxxxx -A "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" all_database.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"_2-3-备份部分数据库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-备份部分数据库"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.3")]),s._v(" "),t("strong",[s._v("备份部分数据库")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysqldump –u user –h "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" –p --databases "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("数据库的名称1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("数据库的名称2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" 备份文件名 称.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysqldump -uroot -p --databases atguigu atguigu12 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("two_database.sql\nmysqldump -uroot -p -B atguigu atguigu12 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" two_database.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"_2-4-备份部分表"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-备份部分表"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.4")]),s._v(" "),t("strong",[s._v("备份部分表")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysqldump –u user –h "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" –p 数据库的名称 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("表名1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("表名2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" 备份文件名称.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysqldump -uroot -p atguigu book"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" book.sql\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#备份多张表 ")]),s._v("\nmysqldump -uroot -p atguigu book account "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" 2_tables_bak.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"_2-5-备份单表的部分数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-备份单表的部分数据"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.5")]),s._v(" "),t("strong",[s._v("备份单表的部分数据")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysqldump -uroot -p atguigu student --where"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id < 10 "')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" student_part_id10_low_bak.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_2-6-排除某些表的备份"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-排除某些表的备份"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.6")]),s._v(" "),t("strong",[s._v("排除某些表的备份")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysqldump -uroot -p atguigu --ignore-table"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("atguigu.student "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" no_stu_bak.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_2-7-只备份结构或只备份数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-7-只备份结构或只备份数据"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.7")]),s._v(" "),t("strong",[s._v("只备份结构或只备份数据")])]),s._v(" "),t("ul",[t("li",[s._v("只备份结构")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysqldump -uroot -p atguigu --no-data "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" atguigu_no_data_bak.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("只备份数据")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysqldump -uroot -p atguigu --no-create-info "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" atguigu_no_create_info_bak.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_2-8-备份中包含存储过程、函数、事件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-8-备份中包含存储过程、函数、事件"}},[s._v("#")]),s._v(" "),t("strong",[s._v("2.8")]),s._v(" "),t("strong",[s._v("备份中包含存储过程、函数、事件")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysqldump -uroot -p -R -E --databases atguigu "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" fun_atguigu_bak.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"_3-mysql命令恢复数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-mysql命令恢复数据"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3. mysql命令恢复数据")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysql –u root –p "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("dbname"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" backup.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_3-1-单库备份中恢复单库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-单库备份中恢复单库"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.1")]),s._v(" "),t("strong",[s._v("单库备份中恢复单库")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#备份文件中包含了创建数据库的语句")]),s._v("\nmysql -uroot -p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" atguigu.sql\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#备份文件中不包含了创建数据库的语句")]),s._v("\nmysql -uroot -p atguigu"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("4")]),s._v("<")]),s._v(" atguigu.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h3",{attrs:{id:"_3-2-全量备份恢复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-全量备份恢复"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.2")]),s._v(" "),t("strong",[s._v("全量备份恢复")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysql –u root –p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" all.sql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_3-3-从全量备份中恢复单库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-从全量备份中恢复单库"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.3")]),s._v(" "),t("strong",[s._v("从全量备份中恢复单库")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -n "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/^-- Current Database: `atguigu`/,/^-- Current Database: `/p'")]),s._v(" all_database.sql "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" atguigu.sql \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#分离完成后我们再导入atguigu.sql即可恢复单个库")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"_3-4-从单库备份中恢复单表"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-从单库备份中恢复单表"}},[s._v("#")]),s._v(" "),t("strong",[s._v("3.4")]),s._v(" "),t("strong",[s._v("从单库备份中恢复单表")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" atguigu.sql "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/./{H;$!d;}'")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'x;/CREATE TABLE `class`/!d;q'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" class_structure.sql \n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" atguigu.sql "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" --ignore-case "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'insert into `class`'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" class_data.sql \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#用shell语法分离出创建表的语句及插入数据的语句后 再依次导出即可完成恢复 ")]),s._v("\n\nuse atguigu"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \nmysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" class_structure.sql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \nQuery OK, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" rows affected, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" warning "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" sec"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \n\nmysql"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" class_data.sql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \nQuery OK, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" row affected "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.01")]),s._v(" sec"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h2",{attrs:{id:"_4-表的导出与导入"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-表的导出与导入"}},[s._v("#")]),s._v(" "),t("strong",[s._v("4.")]),s._v(" "),t("strong",[s._v("表的导出与导入")])]),s._v(" "),t("h3",{attrs:{id:"_4-1-表的导出"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-表的导出"}},[s._v("#")]),s._v(" "),t("strong",[s._v("4.1")]),s._v(" "),t("strong",[s._v("表的导出")])]),s._v(" "),t("p",[t("strong",[s._v("1.")]),s._v(" "),t("strong",[s._v("使用SELECT…INTO OUTFILE导出文本文件")])]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("SHOW GLOBAL VARIABLES LIKE '%secure%';\nSELECT * FROM account INTO OUTFILE \"/var/lib/mysql-files/account.txt\";\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("strong",[s._v("2.")]),s._v(" "),t("strong",[s._v("使用mysqldump命令导出文本文件")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysqldump -uroot -p -T "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/lib/mysql-files/"')]),s._v(" atguigu account\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 或")]),s._v("\nmysqldump -uroot -p -T "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/lib/mysql-files/"')]),s._v(" atguigu account --fields-terminated- "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("by")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("','")]),s._v(" --fields-optionally-enclosed-by"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\\"'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[t("strong",[s._v("3.")]),s._v(" "),t("strong",[s._v("使用mysql命令导出文本文件")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysql -uroot -p --execute"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"SELECT * FROM account;"')]),s._v(" atguigu"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/lib/mysql-files/account.txt"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"_4-2-表的导入"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-表的导入"}},[s._v("#")]),s._v(" "),t("strong",[s._v("4.2")]),s._v(" "),t("strong",[s._v("表的导入")])]),s._v(" "),t("p",[t("strong",[s._v("1.")]),s._v(" "),t("strong",[s._v("使用LOAD DATA INFILE方式导入文本文件")])]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("LOAD DATA INFILE '/var/lib/mysql-files/account_0.txt' INTO TABLE atguigu.account;\n# 或\nLOAD DATA INFILE '/var/lib/mysql-files/account_1.txt' INTO TABLE atguigu.account FIELDS TERMINATED BY ',' ENCLOSED BY '\\\"';\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[t("strong",[s._v("2.")]),s._v(" "),t("strong",[s._v("使用mysqlimport方式导入文本文件")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("mysqlimport -uroot -p atguigu "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/var/lib/mysql-files/account.txt'")]),s._v(" --fields-terminated- "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("by")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("','")]),s._v(" --fields-optionally-enclosed-by"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\\"'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])}),[],!1,null,null,null);a.default=r.exports}}]);